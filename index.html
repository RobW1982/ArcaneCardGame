<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Card Reading</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCS8m0Fg-A_UV-cyuACBsbkaekU3R-HDAc",
            authDomain: "arcanecardgame.firebaseapp.com",
            databaseURL: "https://arcanecardgame-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "arcanecardgame",
            storageBucket: "arcanecardgame.firebasestorage.app",
            messagingSenderId: "373471209915",
            appId: "1:373471209915:web:25329dabf4c4093b057c9e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const gameStateRef = ref(database, 'gameState');

        // Game logic
        let currentGameState = null;

        const arcaneSymbols = ['â˜½', 'âœ¦', 'âš', 'â›¤', 'â›§', 'â—‰'];

        function createNewGame(count) {
            let newCards;
            
            // Every 4th game - all frowning faces
            if (count % 4 === 0) {
                newCards = Array(6).fill('ðŸ˜ˆ');
            } else {
                newCards = ['ðŸ˜', 'ðŸ˜', 'ðŸ˜', 'ðŸ˜ˆ', 'ðŸ˜ˆ', 'ðŸ˜ˆ'];
                // Shuffle
                for (let i = newCards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newCards[i], newCards[j]] = [newCards[j], newCards[i]];
                }
            }
            
            return {
                cards: newCards,
                flipped: Array(6).fill(false),
                gameCount: count,
                isFlipping: false,
                lastFlipTime: Date.now()
            };
        }

        // Auto-recovery: Check if game is stuck and reset it
        async function checkForStuckState() {
            if (!currentGameState) return;
            
            // If game has been flipping for more than 5 seconds, something went wrong
            if (currentGameState.isFlipping) {
                const timeSinceLastFlip = Date.now() - (currentGameState.lastFlipTime || 0);
                if (timeSinceLastFlip > 5000) {
                    console.log('Game stuck, auto-recovering...');
                    const recoveredState = {
                        ...currentGameState,
                        isFlipping: false,
                        flipped: Array(6).fill(false)
                    };
                    await set(gameStateRef, recoveredState);
                }
            }
        }

        // Check for stuck states every 2 seconds
        setInterval(checkForStuckState, 2000);

        async function initializeGame() {
            const snapshot = await get(gameStateRef);
            if (!snapshot.exists()) {
                const initialState = createNewGame(1);
                await set(gameStateRef, initialState);
            }
        }

        async function flipCard(index) {
            if (!currentGameState || currentGameState.isFlipping || currentGameState.flipped[index]) return;
            
            const newFlipped = [...currentGameState.flipped];
            newFlipped[index] = true;
            
            const newState = {
                ...currentGameState,
                flipped: newFlipped,
                isFlipping: true,
                lastFlipTime: Date.now()
            };
            
            await set(gameStateRef, newState);
            
            // Show card for 2 seconds, then flip back, then reset
            setTimeout(async () => {
                // Flip all cards back
                const allUnflipped = {
                    ...currentGameState,
                    flipped: Array(6).fill(false),
                    isFlipping: true,
                    lastFlipTime: Date.now()
                };
                await set(gameStateRef, allUnflipped);
                
                // Wait for flip animation, then reset with new cards
                setTimeout(async () => {
                    const newGame = createNewGame(currentGameState.gameCount + 1);
                    await set(gameStateRef, newGame);
                }, 700);
            }, 2000);
        }

        let lastRenderedState = null;

        function renderGame(state) {
            currentGameState = state;
            
            // Only re-render if the state actually changed
            if (lastRenderedState && 
                JSON.stringify(lastRenderedState) === JSON.stringify(state)) {
                return;
            }
            lastRenderedState = state;
            
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-black p-8">
                    <h1 class="text-5xl font-bold text-purple-300 mb-4 drop-shadow-lg" style="text-shadow: 0 0 20px rgba(168, 85, 247, 0.8)">
                        Arcane Card Reading
                    </h1>
                    
                    <div class="text-purple-200 mb-8 text-center">
                        <p class="text-lg mb-2">Click any card to reveal your fate...</p>
                    </div>

                    <div class="grid grid-cols-3 gap-8 mb-8">
                        ${state.cards.map((symbol, index) => `
                            <div
                                id="card-${index}"
                                class="relative w-28 h-40 cursor-pointer ${state.isFlipping ? 'pointer-events-none' : ''}"
                                style="perspective: 1000px;"
                            >
                                <div
                                    class="relative w-full h-full transition-all duration-700"
                                    style="
                                        transform-style: preserve-3d;
                                        transform: ${state.flipped[index] ? 'rotateY(180deg)' : 'rotateY(0deg)'};
                                    "
                                >
                                    <!-- Front of card -->
                                    <div
                                        class="absolute w-full h-full rounded-lg flex items-center justify-center border-2 border-purple-500 shadow-lg"
                                        style="
                                            backface-visibility: hidden;
                                            background: linear-gradient(135deg, #1e1b4b 0%, #4c1d95 100%);
                                            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5), inset 0 0 30px rgba(139, 92, 246, 0.2);
                                        "
                                    >
                                        <div class="text-6xl text-purple-300 animate-pulse" style="text-shadow: 0 0 15px rgba(168, 85, 247, 0.9)">
                                            ${arcaneSymbols[index]}
                                        </div>
                                    </div>

                                    <!-- Back of card -->
                                    <div
                                        class="absolute w-full h-full rounded-lg flex items-center justify-center border-2 shadow-lg"
                                        style="
                                            backface-visibility: hidden;
                                            transform: rotateY(180deg);
                                            background: ${symbol === 'ðŸ˜' 
                                                ? 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)'
                                                : 'linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%)'};
                                            border-color: ${symbol === 'ðŸ˜' ? '#3b82f6' : '#dc2626'};
                                            box-shadow: ${symbol === 'ðŸ˜'
                                                ? '0 0 25px rgba(59, 130, 246, 0.6)'
                                                : '0 0 25px rgba(220, 38, 38, 0.6)'};
                                        "
                                    >
                                        <div class="text-7xl filter drop-shadow-lg">
                                            ${symbol}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="text-purple-300 text-sm opacity-60 text-center max-w-md">
                        All 6 players share this mystical reading. Click one card per round...
                    </div>
                </div>
            `;

            // Add click handlers
            state.cards.forEach((_, index) => {
                const cardElement = document.getElementById(`card-${index}`);
                if (cardElement) {
                    cardElement.addEventListener('click', () => flipCard(index));
                }
            });
        }

        function showLoading() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-black">
                    <div class="text-purple-300 text-2xl animate-pulse">Conjuring cards...</div>
                </div>
            `;
        }

        // Initialize and listen for changes
        showLoading();
        initializeGame().then(() => {
            onValue(gameStateRef, (snapshot) => {
                const state = snapshot.val();
                if (state) {
                    renderGame(state);
                }
            });
        });
    </script>
</body>
</html>
